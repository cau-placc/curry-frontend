name: CI

on:
  push:
  pull_request:

jobs:
  make:
    runs-on: ubuntu-latest
    container:
      image: haskell:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Stack root directory
        env:
          STACKROOT: /tmp/stack
        run: |
          mkdir -p $STACKROOT

      - name: Run make
        env:
          STACKROOT: /tmp/stack
        run: make STACKROOT=$STACKROOT

      - name: Upload Stack cache and build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stack-cache
          path: |
            /tmp/stack
            .stack-work
            bin
          retention-days: 1

  test:
    runs-on: ubuntu-latest
    container:
      image: haskell:latest
    needs: make
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Stack root directory
        env:
          STACKROOT: /tmp/stack
        run: |
          mkdir -p $STACKROOT

      - name: Download Stack cache and build artifacts
        uses: actions/download-artifact@v4
        with:
          name: stack-cache
          path: /

      - name: Run tests
        env:
          STACKROOT: /tmp/stack
        run: make runtests STACKROOT=$STACKROOT
