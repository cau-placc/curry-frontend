\nwfilename{system.nw}\nwbegindocs{0}% -*- noweb-code-mode: c-mode -*-% ===> this file was generated automatically by noweave --- better not edit it
% $Id: system.nw,v 2.10 2004/04/21 21:01:38 wlux Exp $
%
% Copyright (c) 2002-2004, Wolfgang Lux
% See ../LICENSE for the full license.
%
\subsection{System}
The functions in this file implement the primitive actions for the
\texttt{System} module.

\nwenddocs{}\nwbegincode{1}\sublabel{NW3v3Dpe-hUyNu-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-1}}}\moddef{system.c~{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-1}}}\endmoddef\nwstartdeflinemarkup\nwprevnextdefs{\relax}{NW3v3Dpe-hUyNu-2}\nwenddeflinemarkup
#include "config.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <sys/wait.h>
#include "debug.h"
#include "run.h"
#include "heap.h"
#include "stack.h"
#include "threads.h"
#include "eval.h"
#include "cstring.h"
#include "cam.h"
#include "io_monad.h"
#include "trace.h"

\nwalsodefined{\\{NW3v3Dpe-hUyNu-2}\\{NW3v3Dpe-hUyNu-3}\\{NW3v3Dpe-hUyNu-4}\\{NW3v3Dpe-hUyNu-5}\\{NW3v3Dpe-hUyNu-6}}\nwnotused{system.c}\nwendcode{}\nwbegindocs{2}\nwdocspar
The function {\Tt{}progName\nwendquote} returns the name of the program.

\nwenddocs{}\nwbegincode{3}\sublabel{NW3v3Dpe-hUyNu-2}\nwmargintag{{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-2}}}\moddef{system.c~{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-1}}}\plusendmoddef\nwstartdeflinemarkup\nwprevnextdefs{NW3v3Dpe-hUyNu-1}{NW3v3Dpe-hUyNu-3}\nwenddeflinemarkup
DECLARE_ENTRYPOINT(__getProgName);

FUNCTION(__getProgName)
\{
    Node *r;

    EXPORT_LABEL(__getProgName)
 ENTRY_LABEL(__getProgName)
    sp += 1;
    r   = getProgName();
    RETURN(r);
\}

\nwendcode{}\nwbegindocs{4}\nwdocspar
The function {\Tt{}getArgs\nwendquote} returns a list of the command line arguments
excluding the program name.

\nwenddocs{}\nwbegincode{5}\sublabel{NW3v3Dpe-hUyNu-3}\nwmargintag{{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-3}}}\moddef{system.c~{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-1}}}\plusendmoddef\nwstartdeflinemarkup\nwprevnextdefs{NW3v3Dpe-hUyNu-2}{NW3v3Dpe-hUyNu-4}\nwenddeflinemarkup
DECLARE_ENTRYPOINT(__getArgs);

FUNCTION(__getArgs)
\{
    Node *r;

    EXPORT_LABEL(__getArgs)
 ENTRY_LABEL(__getArgs)
    sp += 1;
    r   = getArgs();
    RETURN(r);
\}

\nwendcode{}\nwbegindocs{6}\nwdocspar
The {\Tt{}getEnv\nwendquote} function is used for querying the value of an
environment variable. If the variable is not defined {\Tt{}getEnv\nwendquote} raises
an I/O exception.

\nwenddocs{}\nwbegincode{7}\sublabel{NW3v3Dpe-hUyNu-4}\nwmargintag{{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-4}}}\moddef{system.c~{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-1}}}\plusendmoddef\nwstartdeflinemarkup\nwprevnextdefs{NW3v3Dpe-hUyNu-3}{NW3v3Dpe-hUyNu-5}\nwenddeflinemarkup
DECLARE_ENTRYPOINT(__getEnv);

DECLARE_LABEL(__getEnv_1);

FUNCTION(__getEnv)
\{
    EXPORT_LABEL(__getEnv)
 ENTRY_LABEL(__getEnv)
    CHECK_STACK1();
    sp   -= 1;
    sp[0] = sp[1];
    sp[1] = (Node *)__getEnv_1;
    GOTO(nf_string);
\}

static
FUNCTION(__getEnv_1)
\{
    char *var, *val;
    Node *r;

 ENTRY_LABEL(__getEnv_1)
    var = to_string(sp[0]);
    val = getenv(var);
    free(var);
    if ( val == (char *)0 )
    \{
        sp[0] = prefix_string("environment variable not set: ", sp[0]);
        GOTO(__ioError);
    \}

    sp += 2;
    r   = from_string(val);
    RETURN(r);
\}

\nwendcode{}\nwbegindocs{8}\nwdocspar
The {\Tt{}system\nwendquote} function calls an external program and returns the
result of the evaluation to the Curry program.

\nwenddocs{}\nwbegincode{9}\sublabel{NW3v3Dpe-hUyNu-5}\nwmargintag{{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-5}}}\moddef{system.c~{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-1}}}\plusendmoddef\nwstartdeflinemarkup\nwprevnextdefs{NW3v3Dpe-hUyNu-4}{NW3v3Dpe-hUyNu-6}\nwenddeflinemarkup
DECLARE_ENTRYPOINT(__system);

DECLARE_LABEL(__system_1);

FUNCTION(__system)
\{
    EXPORT_LABEL(__system)
 ENTRY_LABEL(__system)
    CHECK_STACK1();
    sp -= 1;
    sp[0] = sp[1];
    sp[1] = (Node *)__system_1;
    GOTO(nf_string);
\}

static
FUNCTION(__system_1)
\{
    int  res;
    char *cmd;
    Node *r;

 ENTRY_LABEL(__system_1)
    cmd = to_string(sp[0]);
    res = system(cmd);
    free(cmd);
    if ( res == -1 )
    \{
        sp[0] = from_string(strerror(errno));
        GOTO(__ioError);
    \}
    
    sp += 2;
    if ( WIFSIGNALED(res) )
        res = -WTERMSIG(res);
    else
    \{
        ASSERT(WIFEXITED(res));
        res = WEXITSTATUS(res);
    \}

#if !ONLY_BOXED_OBJECTS
    r = mk_int(res);
#else
    CHECK_HEAP(int_node_size);
    r         = (Node *)hp;
    r->i.info = &int_info;
    r->i.i    = res;
    hp       += int_node_size;
#endif
    RETURN(r);
\}

\nwendcode{}\nwbegindocs{10}\nwdocspar
The function {\Tt{}curryExit\nwendquote} terminates the current program and passes
the result value to the operating system using the C library function
{\Tt{}exit\nwendquote}.

\nwenddocs{}\nwbegincode{11}\sublabel{NW3v3Dpe-hUyNu-6}\nwmargintag{{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-6}}}\moddef{system.c~{\nwtagstyle{}\subpageref{NW3v3Dpe-hUyNu-1}}}\plusendmoddef\nwstartdeflinemarkup\nwprevnextdefs{NW3v3Dpe-hUyNu-5}{\relax}\nwenddeflinemarkup
DECLARE_ENTRYPOINT(__curryExit);

FUNCTION(__curryExit)
\{
    EXPORT_LABEL(__curryExit)
 ENTRY_LABEL(__curryExit)
    EVAL_RIGID_INT(__curryExit);
    curry_exit(int_val(sp[0]));
\}
\nwendcode{}

\nwixlogsorted{c}{{system.c}{NW3v3Dpe-hUyNu-1}{\nwixd{NW3v3Dpe-hUyNu-1}\nwixd{NW3v3Dpe-hUyNu-2}\nwixd{NW3v3Dpe-hUyNu-3}\nwixd{NW3v3Dpe-hUyNu-4}\nwixd{NW3v3Dpe-hUyNu-5}\nwixd{NW3v3Dpe-hUyNu-6}}}%

